<!DOCTYPE html>
<html lang="en">

  <head>
    <base href="/"><script>if ( location.href.indexOf('ipfs') !== -1 ){ var ipfsBase = location.href.match(/([^/]*\/){5}/)[0]; document.getElementsByTagName('base')[0].href = ipfsBase; } </script>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Your data, your insight.">
    <meta name="author" content="TallyLab, LLC">

    <title>TallyLab</title>

    <link href="/app/manifest.json" rel="manifest">

    <!-- so much icon -->
    <link href="/app/favicon.ico" rel="icon">
    <link href="/apple-touch-icon.png" rel="apple-touch-icon" />
    <link href="/apple-touch-icon-152x152.png" rel="apple-touch-icon" sizes="152x152" />
    <link href="/apple-touch-icon-167x167.png" rel="apple-touch-icon" sizes="167x167" />
    <link href="/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180" />
    <link href="/icon-hires.png" rel="icon" sizes="192x192" />
    <link href="/icon-normal.png" rel="icon" sizes="128x128" />

    <!-- oh look actual css finally -->
    <link href="/app/css/fonts.css" rel="stylesheet">
    <link href="/app/css/plugins.css" rel="stylesheet">
    <link href="/app/css/tallylab.css" rel="stylesheet">
  </head>

  <body class="re-encrypt">

    <div class="text-center">

      <p style="display:inline-block;width:320px;margin:15px;" class="alert alert-success">
        RE-ENCRYPTION IN PROGRESS
      </p>

      <p style="margin:30px;"><img src="/app/img/tl-loading.gif" alt="loading" /></p>

      <p style="display:inline-block;width:320px;margin:15px;" class="alert alert-danger">
        Do not navigate away from this page or you will lose all of your data!
      </p>

    </div>

    <!-- scripts every lab view needs -->
    <!-- <script src="/app/js/ipfs.min.js"></script> -->
    <!-- <script src="/app/js/orbitdb.min.js"></script> -->
    <script src="/app/js/ipfs-api.min.js"></script>
    <script src="/app/js/libraries.js"></script>
    <script src="/app/js/plugins.js"></script>
    <script src="/app/js/api.js"></script>
    <script>

      // Default result is to redirect user back to the security page
      var outcome = '/app/settings/security.html';

      // Have to wait for a sync event from api.js before we can actually do anything, but then...
      document.addEventListener('sync',determinePath);

      // Check to make sure user arrived here with the correct ingredients to do this
      if ( !localStorage.getItem('userPublic') || !localStorage.getItem('userPrivate') || !localStorage.getItem('userSecurityVersion') ){

        // If not, send them back to security page
        window.location.href = '/app/settings/security.html';

      }

      // Ingredients are in place, so...
      else {

        // Instantiate TallyLab
        window.tl = new TallyLab({
          version: 4.0
        });

        // Start DB
        window.dbengine = new DatabaseEngine();

        // Combo of the above issues 'sync' event from api.js

      }

      function determinePath(){

        document.removeEventListener('sync',determinePath);

        // Stop syncing
        clearInterval(setSyncInterval);

        // Delete backup-related local data because it won't be valid anymore
        localStorage.removeItem('ipns_hash');
        localStorage.removeItem('last_remote_backup');

        // If user is Stripe customer, check identity
        if ( localStorage.getItem("stripe.customer_id") ){

          // Make sure they have payment provider specified, since we weren't always doing this
          localStorage.setItem("payment_provider","Stripe");

          // Decrypt customer ID
          var customer_id_from_localstorage = tl.encryption.decrypt(localStorage.getItem("stripe.customer_id"));

          // If decryption of customer ID fails
          if ( !customer_id_from_localstorage ){
            console.log('Failed to decrypt Stripe customer id. Deleting id.');

            // Remove customer ID
            localStorage.removeItem("stripe.customer_id");

            // Restart this process
            determinePath();
          }

          // If decryption of customer ID succeeds
          else {

            // Get current verification metadata from Stripe
            fetch("https://us-east-2a.ipfs.tallylab.com/payment_history/" + customer_id_from_localstorage + "?bartleby=michael")
              .then(function(res){
                if ( !res.ok ){
                  alert('There was an error fetching your payment info from Stripe, so we can\'t re-encrypt. Please try again later.');
                  window.location.href = "/app/settings/security.html";
                } else {
                  return res.json();
                }
              })
              .then(function(customer){

                // If customer doesn't exist, or decryption of metadata fails
                if ( !customer.verification || !tl.encryption.decrypt(customer.verification) ){
                  console.log('Unable to verify customer. Deleting customer id.');

                  // Remove customer ID
                  localStorage.removeItem("stripe.customer_id");

                  // Restart this process
                  determinePath();
                }

                // Otherwise, we're good to proceed
                else {
                  reencrypt(customer_id_from_localstorage);
                }

              });

          }

        }

        // Not a Stripe customer, so we're good to proceed
        else {
          reencrypt();
        }

      }

      function reencrypt(decrypted_customer_id){

        /* Setup listeners to handle results */

          document.addEventListener('identity-loaded',function(){ // Sent from api.js, indicates we've changed the user's identity

            // If Stripe customer, re-encrypt customer ID & metadata first
            if ( decrypted_customer_id ){

              // Generate metadata and encrypt
              var data = "verification=" + tl.encryption.encrypt(Math.random().toString(36).substring(7));

              // Update metadata in Stripe
              fetch("https://us-east-2a.ipfs.tallylab.com/update_stripe_metadata/" + decrypted_customer_id + "?bartleby=michael",
                {
                  method: 'POST',
                  body: data,
                  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                })
                .then(function(res){
                  if ( !res.ok ){

                    // Redirect user to Billing after re-encrypt so they can see the messaging about what to do if their billing info was lost
                    outcome = '/app/settings/billing.html';

                    // Remove customer ID
                    localStorage.removeItem("stripe.customer_id");

                  } else {

                    // Save newly encrypted customer ID
                    localStorage.setItem("stripe.customer_id", tl.encryption.encrypt(decrypted_customer_id));

                  }

                  // Regardless of outcome, transfer contents of memory into IndexedDB
                  tl.syncDb();

                }); // No second promise cause we're not using any data from the first

            } // Stripe customer

            // Not a Stripe customer, so we're good to proceed
            else {

              // Transfer contents of memory into IndexedDB
              tl.syncDb();

            }

          });

          document.addEventListener('sync',cleanUp); // Sent from api.js

        /* Update user's identity */

          // Bundle Data
          var tallyDataString = JSON.stringify(tl.tallies);
          var collectionDataString = JSON.stringify(tl.collections);

          // Bundle new identity
          var nuPrivate         = localStorage.getItem('userPrivate').split(',');
          var nuPublic          = localStorage.getItem('userPublic').split(',');
          var nuSecurityVersion = localStorage.getItem('userSecurityVersion');
          var nuIdentity        = {
            privateKey: Uint8Array.from(nuPrivate),
            publicKey: Uint8Array.from(nuPublic),
            securityVersion: parseFloat(nuSecurityVersion)
          };

          // Change encryption keys
          tl.encryption.setIdentity(nuIdentity);

      }

      function cleanUp(){

        document.removeEventListener('sync',cleanUp);

        // Delete new keys from localStorage
        localStorage.removeItem('userPublic');
        localStorage.removeItem('userPrivate');
        localStorage.removeItem('userSecurityVersion');

        // Where to now?
        window.location.href = outcome;

      }

    </script>

  </body>

</html>
